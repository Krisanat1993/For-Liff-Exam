<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>LIFF ‡πÅ‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding-top: 15px; font-family: 'Sarabun', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"; }
        #app-container { padding: 15px; }
        #form-view-container { display: none; }
        .iframe-container { position: relative; width: 100%; height: 80vh; }
        #google-form-iframe { width: 100%; height: 100%; border: 1px solid #dee2e6; }
        #iframe-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0); z-index: 10; display: none; cursor: not-allowed; }
        .list-group-item a { text-decoration: none; display: block; padding: 0.75rem 1.25rem; color: #0d6efd; }
        .list-group-item a:hover { background-color: #f8f9fa; }
        #user-info-card { margin-bottom: 20px; padding: 15px; background-color: #e9ecef; border-radius: 0.375rem; }
        h1, h2, h3 { color: #343a40; }
        #error-message-display { color: red; background-color: #fdd; border: 1px solid #fbb; padding: 10px; margin-bottom: 15px; border-radius: 5px; display: none; }
        #forms-loading-spinner { display: none; }
        .form-buttons-container { display: flex; align-items: center; flex-wrap: wrap; }

        /* --- üé® NEW: Tablet UI Adjustments (Fullscreen Form) --- */
        .is-tablet #form-view-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background-color: white; 
            z-index: 100;
            padding: 15px;
            display: none; /* Default ‡∏Ñ‡∏∑‡∏≠‡∏ã‡πà‡∏≠‡∏ô */
            flex-direction: column;
        }
        .is-tablet #form-view-container .iframe-container {
            flex-grow: 1;
            height: 100%;
        }
        .is-tablet #form-view-container #google-form-iframe {
            height: 100%;
        }
        /* --- End Tablet UI Adjustments --- */

        /* --- üîí NEW: Lock Screen Styles --- */
        #lock-screen-overlay {
            display: none; /* ‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75); /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏µ‡πÄ‡∏Ç‡πâ‡∏° */
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ modal ‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á */
        }

        #lock-screen-modal {
            background-color: white;
            padding: 25px;
            border-radius: 8px;
            text-align: center;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        #lock-screen-error {
            color: red; 
            display: none; 
            margin-top: 10px;
            font-size: 0.9rem;
        }
        /* --- End Lock Screen Styles --- */

    </style>
</head>
<body>
    <div id="app-container">
        <div id="error-message-display"></div>
        <div id="user-info-card">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>

        <div id="links-view">
            <h2 class="mb-3">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°</h2>
            <div id="forms-loading-spinner" class="spinner-border text-primary my-3" role="status">
                <span class="visually-hidden">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°...</span>
            </div>
            <ul id="form-links-list" class="list-group">
            </ul>
        </div>

        <div id="form-view-container">
            <h3 id="current-form-title-span" class="mb-3"></h3>
            <div class="form-buttons-container mb-3">
                <button id="back-to-links-page-btn" class="btn btn-outline-secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-left-circle" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1 8a7 7 0 1 0 14 0A7 7 0 0 0 1 8m15 0A8 8 0 1 1 0 8a8 8 0 0 1 16 0m-4.5-.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5z"/></svg>
                    ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                </button>
                <button id="form-completed-success-btn" class="btn btn-success ms-2" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-circle-fill" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0m-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/></svg>
                    ‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß
                </button>
            </div>
            <div class="iframe-container">
                 <iframe id="google-form-iframe" sandbox="allow-scripts allow-forms allow-same-origin allow-popups allow-top-navigation"></iframe>
                 <div id="iframe-overlay"></div>
            </div>
        </div>
    </div>

    <div id="lock-screen-overlay">
        <div id="lock-screen-modal">
            <h3 class="mb-3">üîí ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Ñ</h3>
            <p>‡∏Ñ‡∏∏‡∏ì‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ:</p>
            <input type="password" id="lock-screen-password" class="form-control" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
            <button id="lock-screen-submit" class="btn btn-primary mt-3 w-100">‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ</button>
            <p id="lock-screen-error">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</p>
        </div>
    </div>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
         // =================================================================
        // ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Cache ‡∏Ç‡∏≠‡∏á LIFF
        // =================================================================
        const originalFetch = window.fetch;
        window.fetch = async function(url, options) {
            if (url.toString().startsWith('https://liffsdk.line-scdn.net/') && url.toString().endsWith('.json')) {
                url = url + '?ts=' + Math.random();
            }
            return originalFetch(url, options);
        };
        // =================================================================
    
        // --- ‚öôÔ∏è ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ ---
        // <<<<---- [‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç] ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡πà‡∏≤ 3 ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ô‡∏µ‡πâ ----
        const LIFF_ID = "2006098460-MrXJnJPV"; // ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢ LIFF ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
        const USER_CLIENT_ID = "080625001"; // ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢ Client ID ‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏°‡∏≤‡∏à‡∏≤‡∏Å URL Parameter
        const VERIFICATION_URL = 'https://script.google.com/macros/s/AKfycbxdP176VYX3kP5DoCDBTCA7uol7gbqCJ6y7k39w5H2G94ImV4JCDgbIait9wIeo23w6/exec'; // ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢ URL ‡∏Ç‡∏≠‡∏á "Verification.gs"
        // <<<<------------------------------------

        const SESSION_ID_STORAGE_KEY = 'liffQuizAppSessionId';

        // --- ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô (Global State) ---
        let mainAppUrl = null;
        let liffUserProfile = null;
        let currentActiveForm = null;
        let isIframeInitialLoad = true;
        let isVisibilityListenerActive = false;
        let isFormSubmitted = false;
        let completedFormIds = [];

        // +++ NEW: Lock Screen Password +++
        const UNLOCK_CODE = "ome";
        // +++ END NEW +++

        // +++ üîÑ NEW: Back Button Navigation Flags (‡πÄ‡∏û‡∏¥‡πà‡∏° 2 ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ô‡∏µ‡πâ) +++
        let isNavigatingBackSafely = false;
        let isHandlingPopstate = false; // üëà *** ‡∏ò‡∏á‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤ ***
        // +++ END NEW +++


        // --- DOM Elements ---
        const userInfoDiv = document.getElementById('user-info-card');
        const linksViewDiv = document.getElementById('links-view');
        const formViewContainerDiv = document.getElementById('form-view-container');
        const formLinksUl = document.getElementById('form-links-list');
        const googleFormIframeEl = document.getElementById('google-form-iframe');
        const currentFormTitleEl = document.getElementById('current-form-title-span');
        const backToLinksBtnEl = document.getElementById('back-to-links-page-btn');
        const errorMessageDisplay = document.getElementById('error-message-display');
        const formsLoadingSpinner = document.getElementById('forms-loading-spinner');
        const formCompletedSuccessBtnEl = document.getElementById('form-completed-success-btn');
        const iframeOverlay = document.getElementById('iframe-overlay');

        // +++ NEW: Lock Screen DOM Elements +++
        const lockScreenOverlay = document.getElementById('lock-screen-overlay');
        const lockScreenPasswordInput = document.getElementById('lock-screen-password');
        const lockScreenSubmitBtn = document.getElementById('lock-screen-submit');
        const lockScreenError = document.getElementById('lock-screen-error');
        // +++ END NEW +++

        document.addEventListener('DOMContentLoaded', initializeLiffApp);

        // +++ NEW: Lock Screen Event Listeners +++
        lockScreenSubmitBtn.addEventListener('click', handleUnlockAttempt);
        lockScreenPasswordInput.addEventListener('keyup', (event) => {
            lockScreenError.style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô error ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏û‡∏¥‡∏°‡∏û‡πå
            if (event.key === 'Enter') {
                handleUnlockAttempt();
            }
        });
        // +++ END NEW +++


        async function initializeLiffApp() {
            showError("");
            console.log("DOMContentLoaded, starting initializeLiffApp...");

            // +++ NEW: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Tablet +++
            const isTablet = /Tablet|iPad/i.test(navigator.userAgent);
            if (isTablet) {
                document.body.classList.add('is-tablet');
                console.log("Tablet device detected. Applying full-screen form UI.");
            }
            // +++ END NEW +++

            // +++ üîÑ NEW: Add History/Back Button management (‡πÄ‡∏û‡∏¥‡πà‡∏° listener ‡∏ô‡∏µ‡πâ) +++
            window.addEventListener('popstate', handleBackButton);
            // +++ END NEW +++

            try {
                const storedCompletedForms = localStorage.getItem('completedFormIds');
                if (storedCompletedForms) {
                    completedFormIds = JSON.parse(storedCompletedForms);
                }

                userInfoDiv.innerHTML = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Å‡∏≤‡∏£ LIFF SDK... (‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1/6)';
                await liff.init({ liffId: LIFF_ID });
                
                userInfoDiv.innerHTML = 'LIFF SDK ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£ Login... (‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2/6)';
                if (!liff.isLoggedIn()) {
                    userInfoDiv.innerHTML = '<p class="text-info">‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö LINE...<br>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...</p>';
                    liff.login();
                    return;
                }

                userInfoDiv.innerHTML = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö LINE ‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå... (‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 3/6)';
                
                try {
                    liffUserProfile = await liff.getProfile();
                } catch (profileError) {
                    console.error("Error getting LIFF profile:", profileError);
                    throw new Error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå LINE ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏õ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (Scope: profile)");
                }

                userInfoDiv.innerHTML = `<p class="mb-1"><strong>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏∏‡∏ì:</strong> ${liffUserProfile.displayName}</p> (‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 4/6)`;

                userInfoDiv.innerHTML = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô... (‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 5/6)`;
                await verifyClientAndGetAppUrl();
                console.log("Client verified successfully. Main App URL is set.");

                userInfoDiv.innerHTML = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°... (‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 6/6)`;
                await fetchAndRenderFormLinks();

                userInfoDiv.innerHTML = `
                    <p class="mb-1"><strong>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏∏‡∏ì:</strong> ${liffUserProfile.displayName}</p>
                    <p class="text-success mb-0"><small>‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</small></p>`;

                navigateToLinksPage();
            } catch (error) {
                console.error("Initialization or Verification Error:", error);
                const userMessage = `<strong>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:</strong> ${error.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô‡πÑ‡∏î‡πâ'}`;
                showError(userMessage);
                userInfoDiv.innerHTML = `<p class="text-danger">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á Refresh ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>`;
                linksViewDiv.style.display = 'none';
            }
        }

        async function verifyClientAndGetAppUrl() {
            if (!USER_CLIENT_ID) throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Client ID) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå");
            if (!VERIFICATION_URL || VERIFICATION_URL.includes('...')) throw new Error("‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (VERIFICATION_URL)");

            const url = `${VERIFICATION_URL}?action=verifyClient&user_client_id=${USER_CLIENT_ID}&t=${new Date().getTime()}`;
            const response = await fetch(url);

            if (!response.ok) throw new Error(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏î‡πâ (HTTP Status: ${response.status})`);
            
            const result = await response.json();
            
            if (result.status === 'success' && result.web_app_url) {
                mainAppUrl = result.web_app_url;
            } else {
                let errorMessage = result.message || "‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß";
                
                // --- CHANGED: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÇ‡∏î‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ---
                if (result.status === 'expired') {
                    errorMessage = '‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ <a href="https://lin.ee/dadcyUE" target="_blank" rel="noopener noreferrer">https://lin.ee/dadcyUE</a>';
                }
                // --------------------------------------------------------

                if (result.status === 'not_found') {
                    errorMessage = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£";
                }
                
                throw new Error(errorMessage);
            }
        }
        
        async function fetchAndRenderFormLinks() {
            if (!mainAppUrl) {
                showError("<strong>‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á:</strong> ‡πÑ‡∏°‡πà‡∏û‡∏ö URL ‡∏Ç‡∏≠‡∏á‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ");
                return;
            }
            formsLoadingSpinner.style.display = 'block';
            formLinksUl.innerHTML = '';
            try {
                const response = await fetch(`${mainAppUrl}?action=getFormConfigs&t=${new Date().getTime()}`);
                if (!response.ok) throw new Error(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ Server ‡πÑ‡∏î‡πâ (HTTP status: ${response.status})`);
                const result = await response.json();
                if (result.status === "success") {
                    if (result.sessionId !== undefined) {
                        const serverSessionId = String(result.sessionId);
                        const storedSessionId = localStorage.getItem(SESSION_ID_STORAGE_KEY);
                        if (serverSessionId !== storedSessionId) {
                            completedFormIds = [];
                            localStorage.removeItem('completedFormIds');
                            localStorage.setItem(SESSION_ID_STORAGE_KEY, serverSessionId);
                        }
                    }
                    if (Array.isArray(result.data) && result.data.length > 0) {
                        renderFormLinks(result.data);
                    } else {
                        formLinksUl.innerHTML = `<li class="list-group-item text-muted">${result.message || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°'}</li>`;
                    }
                } else {
                    throw new Error(result.message || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡πÑ‡∏î‡πâ");
                }
            } catch (error) {
                showError(`<strong>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°:</strong> ${error.message}`);
            } finally {
                formsLoadingSpinner.style.display = 'none';
            }
        }

        function renderFormLinks(formsData) {
            formLinksUl.innerHTML = "";
            let hasVisibleForms = false;
            formsData.forEach(form => {
                const listItem = document.createElement('li');
                listItem.className = 'list-group-item p-0';
                const link = document.createElement('a');
                link.href = '#';
                if (completedFormIds.includes(form.id)) {
                    link.textContent = `${form.title} (‡∏ó‡∏≥‡πÅ‡∏•‡πâ‡∏ß)`;
                    link.className = 'text-muted';
                    link.style.textDecoration = 'line-through';
                    link.onclick = (e) => e.preventDefault();
                    listItem.style.backgroundColor = '#e9ecef';
                } else {
                    link.textContent = form.title;
                    link.onclick = (e) => { e.preventDefault(); loadFormIntoIframeView(form); };
                    hasVisibleForms = true;
                }
                listItem.appendChild(link);
                formLinksUl.appendChild(listItem);
            });
            if (!hasVisibleForms && formsData.length > 0) {
                formLinksUl.innerHTML = '<li class="list-group-item text-success">‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!</li>';
            }
        }

        function showError(message) {
            errorMessageDisplay.innerHTML = message;
            errorMessageDisplay.style.display = message ? 'block' : 'none';
        }

        function navigateToLinksPage() {
            // +++ üìù MODIFIED +++
            if (document.body.classList.contains('is-tablet')) {
                userInfoDiv.style.display = 'block';
                linksViewDiv.style.display = 'block';
                formViewContainerDiv.style.display = 'none';
            } else {
                linksViewDiv.style.display = 'block';
                formViewContainerDiv.style.display = 'none';
            }
            // +++ END MODIFIED +++

            // +++ NEW: Ensure lock screen is hidden +++
            hideLockScreen();
            // +++ END NEW +++

            if (googleFormIframeEl.src !== 'about:blank') {
                googleFormIframeEl.src = 'about:blank';
            }
            currentActiveForm = null;
            isFormSubmitted = false;
            removeVisibilityChangeListener();
            document.title = "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°";
            fetchAndRenderFormLinks();
        }

        function navigateToFormPage(form) {
            // +++ üìù MODIFIED +++
            if (document.body.classList.contains('is-tablet')) {
                userInfoDiv.style.display = 'none';
                linksViewDiv.style.display = 'none';
                formViewContainerDiv.style.display = 'flex'; // üëà **‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô 'flex'**
            } else {
                linksViewDiv.style.display = 'none';
                formViewContainerDiv.style.display = 'block'; // üëà **‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°**
            }
            // +++ END MODIFIED +++

            currentFormTitleEl.textContent = form.title;
            document.title = form.title;
        }

        function updateFormViewButtons() {
            if (currentActiveForm) {
                formCompletedSuccessBtnEl.style.display = isFormSubmitted ? 'inline-block' : 'none';
                backToLinksBtnEl.disabled = isFormSubmitted;
            }
        }

        function loadFormIntoIframeView(form) {
            currentActiveForm = form;
            isFormSubmitted = false;
            iframeOverlay.style.display = 'none';
            navigateToFormPage(form);
            updateFormViewButtons();
            let targetFormUrl = form.url;
            if (!targetFormUrl.includes('embedded=true')) {
                targetFormUrl += (targetFormUrl.includes('?') ? '&' : '?') + 'embedded=true';
            }
            isIframeInitialLoad = true;
            googleFormIframeEl.src = targetFormUrl;

            // +++ üîÑ NEW: Push a new history state to intercept the back button (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ) +++
            history.pushState({ page: "formView", ts: Date.now() }, form.title, "#form");
            // +++ END NEW +++
        }

        // --- üîÑ MODIFIED: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ---
        googleFormIframeEl.onload = function() {
            // *** 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ò‡∏á‡∏Å‡πà‡∏≠‡∏ô ***
            if (isHandlingPopstate) {
                // ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠ onload ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
                isHandlingPopstate = false; // ‡πÄ‡∏≠‡∏≤‡∏ò‡∏á‡∏•‡∏á
                return; // üõë ‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ! ‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡∏ï‡πà‡∏≠
            }

            const iframeSrc = googleFormIframeEl.getAttribute('src');
            if (!currentActiveForm || iframeSrc === 'about:blank' || !iframeSrc.startsWith('http')) return;

            if (isIframeInitialLoad) {
                isIframeInitialLoad = false;
                logEventToSheet(`‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏£‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°: ${currentActiveForm.title}`);
                addVisibilityChangeListener();
            } else {
                // ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 2 (‡∏ó‡∏µ‡πà *‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà* popstate)
                // ‡∏™‡∏±‡∏ô‡∏ô‡∏¥‡∏©‡∏ê‡∏≤‡∏ô‡∏ß‡πà‡∏≤‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏≤‡∏£ "‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à" ‡∏à‡∏£‡∏¥‡∏á‡πÜ
                isFormSubmitted = true;
                iframeOverlay.style.display = 'block';
                logEventToSheet(`‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏™‡∏±‡∏ô‡∏ô‡∏¥‡∏©‡∏ê‡∏≤‡∏ô): ${currentActiveForm.title}`);
            }
            updateFormViewButtons();
        };
        // --- üîÑ END MODIFIED ---

        // --- üîÑ MODIFIED: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Event Listener ‡∏ô‡∏µ‡πâ ---
        backToLinksBtnEl.addEventListener('click', () => {
            logEventToSheet(`‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÅ‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á: ${currentActiveForm.title}`);
            
            // ‡∏ï‡∏±‡πâ‡∏á‡∏ò‡∏á‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏ó‡∏µ‡πà "‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢"
            isNavigatingBackSafely = true;
            history.back(); // ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
            // navigateToLinksPage(); // üëà ‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß
        });
        // --- üîÑ END MODIFIED ---

        // --- üîÑ MODIFIED: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Event Listener ‡∏ô‡∏µ‡πâ ---
        formCompletedSuccessBtnEl.addEventListener('click', () => {
            if (currentActiveForm) {
                if (!completedFormIds.includes(currentActiveForm.id)) {
                    completedFormIds.push(currentActiveForm.id);
                    localStorage.setItem('completedFormIds', JSON.stringify(completedFormIds));
                }
                logEventToSheet(`‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${currentActiveForm.title}`);
                
                // ‡∏ï‡∏±‡πâ‡∏á‡∏ò‡∏á‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏ó‡∏µ‡πà "‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢"
                isNavigatingBackSafely = true;
                history.back(); // ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
                // navigateToLinksPage(); // üëà ‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß
            }
        });
        // --- üîÑ END MODIFIED ---

        // +++ üîÑ NEW: Function to handle browser back button (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ) +++
        function handleBackButton(event) {
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏£‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            if (currentActiveForm) {
                if (isNavigatingBackSafely) {
                    // ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏ó‡∏µ‡πà "‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï" (‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤)
                    navigateToLinksPage(); 
                    isNavigatingBackSafely = false; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ò‡∏á
                } else {
                    // ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏ó‡∏µ‡πà "‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï" (‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° Back ‡∏Ç‡∏≠‡∏á Device)
                    
                    // *** 1. ‡∏ï‡∏±‡πâ‡∏á‡∏ò‡∏á‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏°‡πà ***
                    isHandlingPopstate = true; 
                    
                    // *** 2. "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å" ‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö ***
                    history.pushState({ page: "formView", ts: Date.now() }, currentActiveForm.title, "#form");
                    
                    // ‡πÄ‡∏£‡∏≤‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡∏ï‡πà‡∏≠‡πÄ‡∏•‡∏¢ ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏∞‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°
                }
            }
        }
        // +++ END NEW +++


        function handleVisibilityChange() {
            if (!currentActiveForm || !isVisibilityListenerActive) return;
            
            if (document.hidden) {
                // +++ üìù MODIFIED: Trigger Lock Screen +++
                logEventToSheet(`‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠/‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏ì‡∏∞‡∏ó‡∏≥: ${currentActiveForm.title}`);
                
                // ‡∏•‡πá‡∏≠‡∏Ñ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á
                if (!isFormSubmitted) {
                    showLockScreen();
                }
                // +++ END MODIFIED +++
            }
        }

        function addVisibilityChangeListener() {
            if (!isVisibilityListenerActive) {
                document.addEventListener('visibilitychange', handleVisibilityChange);
                isVisibilityListenerActive = true;
            }
        }

        function removeVisibilityChangeListener() {
            if (isVisibilityListenerActive) {
                document.removeEventListener('visibilitychange', handleVisibilityChange);
                isVisibilityListenerActive = false;
            }
        }

        // +++ NEW: Lock Screen Functions +++
        function showLockScreen() {
            // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Ñ‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô
            if (lockScreenOverlay.style.display === 'flex') return;
            
            console.log("Showing lock screen due to visibility change.");
            lockScreenPasswordInput.value = ""; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡πà‡∏≤
            lockScreenError.style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° error
            lockScreenOverlay.style.display = 'flex'; // ‡πÅ‡∏™‡∏î‡∏á Pop-up
            lockScreenPasswordInput.focus(); // Focus ‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™
        }

        function hideLockScreen() {
            console.log("Hiding lock screen.");
            lockScreenOverlay.style.display = 'none';
            lockScreenPasswordInput.value = "";
            lockScreenError.style.display = 'none';
        }

        function handleUnlockAttempt() {
            const inputPassword = lockScreenPasswordInput.value;
            if (inputPassword === UNLOCK_CODE) {
                hideLockScreen();
            } else {
                lockScreenError.style.display = 'block'; // ‡πÅ‡∏™‡∏î‡∏á error
                lockScreenPasswordInput.value = ""; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ä‡πà‡∏≠‡∏á
                lockScreenPasswordInput.focus(); // ‡πÉ‡∏´‡πâ focus ‡πÉ‡∏´‡∏°‡πà
            }
        }
        // +++ END NEW +++
        
        async function logEventToSheet(message) {
            if (!mainAppUrl) return;
            const payload = new FormData();
            payload.append('timestamp', new Date().toISOString());
            payload.append('userId', liffUserProfile ? liffUserProfile.userId : 'N/A');
            payload.append('displayName', liffUserProfile ? liffUserProfile.displayName : 'N/A');
            payload.append('formId', currentActiveForm ? currentActiveForm.id : 'N/A');
            payload.append('formTitle', currentActiveForm ? currentActiveForm.title : 'N/A');
            payload.append('message', message);
            payload.append('userAgent', navigator.userAgent);
            payload.append('liffClientVersion', liff.getVersion() || 'N/A');
            payload.append('isInClient', String(liff.isInClient()));
            payload.append('os', liff.getOS() || 'N/A');
            payload.append('language', liff.getLanguage() || 'N/A');
            const context = liff.getContext();
            if (context) {
                payload.append('lineContextType', context.type || 'N/A');
                payload.append('lineContextViewType', context.viewType || 'N/A');
                payload.append('lineContextUtouId', context.utouId || 'N/A');
                payload.append('lineContextRoomId', context.roomId || 'N/A');
                payload.append('lineContextGroupId', context.groupId || 'N/A');
                payload.append('lineIsAuthenticated', context.accessToken ? 'true' : 'false');
            }
            try {
                await fetch(mainAppUrl, { method: 'POST', mode: 'no-cors', body: payload });
            } catch (error) {
                console.error('Error sending data to Google Sheet:', error);
            }
        }
    </script>
</body>
</html>
